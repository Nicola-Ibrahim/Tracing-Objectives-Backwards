\def\laneSep{30mm} % vertical gap between training and inference lanes

\begin{tikzpicture}
  \definecolor{panelBlue}{RGB}{33,111,219}
  \definecolor{softGray}{RGB}{246,248,250}

  \tikzset{
    >={Latex[length=2.6mm]},
    font=\sffamily,
    panel/.style={draw, rounded corners=8pt, line width=0.8pt, fill=panelBlue!6},
    box/.style={draw, rounded corners=6pt, line width=0.8pt, fill=white,
                align=center, inner sep=7pt, minimum height=10mm, text width=34mm},
    small/.style={box, text width=24mm},
    flow/.style={-Latex, line width=0.9pt},
    labelchip/.style={fill=softGray, rounded corners=3pt, inner sep=1.2pt,
                      font=\scriptsize, align=center}
  }

  %---------------- CONTENT ----------------
  \begin{scope}[local bounding box=content]

    % ===== Training lane =====
    \node[small]                               (xtr)   at (-4.9, 1.2) {$\mathbf{X}$\\{\scriptsize features}};
    \node[box,      right=12mm of xtr]         (model) {$g_{\theta}$\\{\scriptsize deterministic model (e.g., LR)}};
    \node[small,    right=12mm of model]       (yhat)  {$\hat{\mathbf{y}}$\\{\scriptsize prediction}};
    \node[small,    above=10mm of yhat]        (ytrue) {$\mathbf{y}$\\{\scriptsize target}};
    \node[box,      right=12mm of yhat]        (loss)  {Loss $\;\ell(\hat{\mathbf{y}},\mathbf{y})$\\{\scriptsize ERM objective}};

    \draw[flow] (xtr) -- node[above, labelchip]{input} (model);
    \draw[flow] (model) -- node[above, labelchip]{output} (yhat);
    \draw[flow] (ytrue) -- node[right, labelchip]{supervision} (loss.north);
    \draw[flow] (yhat)  -- (loss);
    \draw[flow] (loss.south) |- ++(-24mm,-10mm) -| node[pos=0.25, below, labelchip]{update $\theta$} (model.south);

    % lane title
    \node[anchor=west, font=\bfseries] at ([yshift=9mm]xtr.north west) {Training};

    % === Fit node to capture training bounds, then define the gap line ===
    \node[inner sep=0, fit=(xtr)(model)(yhat)(ytrue)(loss), name=trainLane] {};
    \coordinate (laneY) at ([yshift=-\laneSep]trainLane.south);

    % ===== Inference lane =====
    % Place the first inference node aligned in x with xtr, at y = laneY
    \node[small] at ($(xtr|-laneY)$)            (xnew)  {$\mathbf{X}^{\!*}$\\{\scriptsize new features}};
    \node[box,   right=12mm of xnew]            (model2){$g_{\hat{\theta}}$\\{\scriptsize trained model}};
    \node[small, right=12mm of model2]          (ypred) {$\hat{\mathbf{y}}$\\{\scriptsize output}};

    \draw[flow] (xnew) -- (model2);
    \draw[flow] (model2) -- (ypred);

    \node[anchor=west, font=\bfseries] at ([yshift=9mm]xnew.north west) {Inference};
  \end{scope}

  %---------------- PANEL & TITLE ----------------
  \begin{scope}[on background layer]
    \node[panel, fit=(content), inner sep=12pt] (P) {};
  \end{scope}


  \path[use as bounding box] (P.south west) rectangle (P.north east);

  \node[anchor=north west, font=\bfseries\large]
       at ([xshift=6pt,yshift=-6pt]P.north west) {Deterministic Supervised Modelling};
\end{tikzpicture}
