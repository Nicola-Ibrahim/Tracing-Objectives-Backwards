\begin{tikzpicture}
  % ===== Local colors & styles (only for this picture) =====
  \definecolor{probGreenB}{RGB}{30,145,85}
  \definecolor{softGrayB}{RGB}{246,248,250}
  \tikzset{
    >={Latex[length=2.4mm]},
    font=\sffamily,
    % Panel style (no fixed size; the fit node will size it)
    panelB/.style={
      draw, rounded corners=8pt, line width=0.8pt, fill=probGreenB!6
    },
    % Wrapped node styles
    boxB/.style={
      draw, rounded corners=6pt, line width=0.8pt, fill=white,
      inner sep=7pt, minimum height=10mm,
      align=center, text width=35mm
    },
    smallB/.style={boxB, text width=22mm},
    wideB/.style={boxB, text width=35mm},
    noteB/.style={
      align=left,font=\scriptsize,inner sep=1pt,text opacity=0.85,
      text width=12.2cm
    },
    circB/.style={circle, draw, fill=white, line width=0.8pt, minimum size=8mm,
                  align=center, text width=8mm},
    flowB/.style={-Latex, line width=0.9pt},
    softlabelB/.style={fill=softGrayB, text=black, rounded corners=3pt,
                       inner sep=1.2pt, font=\scriptsize, align=center, text width=28mm}
  }

  %------------------------------------------------------------------
  % Put ALL content inside a scope to capture its bounding box.
  %------------------------------------------------------------------
  \begin{scope}[local bounding box=content]
    % ===== Input & conditional model =====
    \node[smallB] (xstar) at (-6.0,1.1) {$\mathbf{x}^{\star}$\\{\scriptsize input}};
    \node[wideB, right=15mm of xstar] (pyx) {$p_\theta(\mathbf{y}\mid \mathbf{x})$\\{\scriptsize conditional model}};

    % ===== Samples from p(y|x) =====
    \node[circB, right=15mm of pyx, yshift=8mm, minimum size=7.5mm] (y1) {$\mathbf{y}_1$};
    \node[circB, right=15mm of pyx, minimum size=7.5mm] (y2) {$\mathbf{y}_2$};
    \node[circB, right=15mm of pyx, yshift=-8mm, minimum size=7.5mm] (y3) {$\mathbf{y}_3$};

    % ===== Decision rule and final prediction =====
    \node[wideB, right=16mm of y2] (select) {Decision rule\\{\scriptsize MAP / posterior mean / quantile}};
    \node[smallB, right=16mm of select] (yhat) {$\hat{\mathbf{y}}$\\{\scriptsize prediction}};

    % ===== Ground-truth label (optional visual link) =====
    \node[smallB, below=11mm of select, text width=28mm] (ytrue) {$\mathbf{y}^{\star}$\\{\scriptsize ground truth}};
    \node[boxB, right=10mm of ytrue, text width=38mm] (loss) {Loss / metric\\{\scriptsize $\ell(\hat{\mathbf{y}},\mathbf{y}^{\star})$}};

    % ===== Arrows =====
    \draw[flowB] (xstar) -- node[above,softlabelB]{condition on $\mathbf{x}^{\star}$} (pyx);
    \foreach \y in {y1,y2,y3}{
      \draw[flowB] (pyx.east) -- ++(6mm,0) |- (\y.west);
      \draw[flowB] (\y.east) -- (select.west);
    }
    \draw[flowB] (select) -- (yhat);

    % dashed links to show supervised signal
    \draw[dashed, line width=0.6pt] (ytrue) -- (loss);
    \draw[dashed, line width=0.6pt] (yhat) |- (loss);
  \end{scope}

  %------------------------------------------------------------------
  % Background panel that FITS the content (includes arrows/edges).
  % Use backgrounds+fit to put the panel behind the content.
  %------------------------------------------------------------------
  \begin{scope}[on background layer]
    % add some padding around content with inner sep
    \node[panelB, fit=(content), inner sep=12pt] (Q) {};
  \end{scope}

  % Panel title placed relative to the fitted panel
  \node[anchor=north west, font=\bfseries\large]
       at ([xshift=6pt,yshift=-6pt]Q.north west) {Probabilistic Modelling (supervised)};
\end{tikzpicture}
