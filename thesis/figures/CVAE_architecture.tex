\begin{tikzpicture}[
    % --- Global Definitions (Matching MDN) ---
    execute at begin picture={
        \definecolor{colMain}{RGB}{0, 119, 182}
        \definecolor{colLatent}{RGB}{114, 9, 183}
        \definecolor{colResult}{RGB}{43, 147, 72}
        \definecolor{colGray}{RGB}{240, 240, 240}
    },
    >=Stealth, thick, node distance=1.4cm,
    font=\sffamily\footnotesize,
    % --- Styles ---
    io/.style={draw, fill=white, minimum width=1.8cm, minimum height=0.7cm, rounded corners=3pt},
    net/.style={draw, fill=colMain!10, text=colMain, font=\sffamily\bfseries\footnotesize, minimum width=2.8cm, minimum height=0.9cm, rounded corners=4pt},
    latent/.style={draw=colLatent, fill=colLatent!10, text=colLatent, circle, inner sep=3pt, font=\sffamily\bfseries\small},
    cat/.style={draw, fill=colGray, circle, inner sep=2pt, font=\scriptsize, minimum size=0.5cm},
    container/.style={draw=black!10, fill=black!2, dashed, rounded corners=10pt, inner sep=15pt}
]

    % --- ENCODER PATH (Training) ---
    \node[io] (x_in) {Decision $\mathbf{x}$};
    \node[io, right=1.2cm of x_in] (y_in) {Outcome $\mathbf{y}$};
    
    % Added gap here
    \node[cat, below=0.8cm of $(x_in.south)!0.5!(y_in.south)$] (cat1) {+};
    
    \node[net, below=0.8cm of cat1] (enc) {Encoder NN\\$q_\phi(\mathbf{z}|\mathbf{x}, \mathbf{y})$};
    
    % --- LATENT SPACE (The Bottleneck) ---
    \node[latent, below=1.4cm of enc] (z) {$\mathbf{z}$};
    \node[right=0.6cm of z, font=\tiny, text=black!60, align=left] {Reparameterization\\$\mathbf{z} = \mu + \sigma \odot \epsilon$};

    % --- DECODER PATH (Inference) ---
    % Significant padding added around 'cat2'
    \node[net, below=1.8cm of z] (dec) {Decoder NN\\$p_\theta(\hat{\mathbf{x}}|\mathbf{z}, \mathbf{y})$};
    
    \node[cat, left=1.8cm of dec] (cat2) {+}; % Increased gap before and after
    \node[io, left=1.2cm of cat2] (y_query) {Query $\mathbf{y}^\star$};

    \node[io, below=1cm of dec, fill=colResult, text=white, font=\sffamily\bfseries] (x_out) {Candidate $\hat{\mathbf{x}}$};

    % --- BACKGROUNDS ---
    \begin{scope}[on background layer]
        \node[container, fit=(x_in) (y_in) (enc), label={[text=black!40, font=\tiny\bfseries]north:ENCODER STAGE}] {};
        \node[container, fit=(y_query) (cat2) (dec) (x_out), label={[text=black!40, font=\tiny\bfseries]south:DECODER STAGE}] {};
    \end{scope}

    % --- CONNECTIONS ---
    \draw[->] (x_in.south) -- ++(0,-0.3) -| (cat1.north);
    \draw[->] (y_in.south) -- ++(0,-0.3) -| (cat1.north);
    \draw[->] (cat1) -- (enc);
    \draw[->] (enc) -- (z);
    
    \draw[->] (z) -- (dec);
    \draw[->] (y_query) -- (cat2) node[midway, above, font=\tiny, text=black!50] {context};
    \draw[->] (cat2) -- (dec) node[midway, above, font=\tiny, text=black!50] {concat};
    \draw[->] (dec) -- (x_out);


\end{tikzpicture}